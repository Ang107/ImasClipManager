<Window x:Class="ImasClipManager.Views.ClipEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:models="clr-namespace:ImasClipManager.Models"
        Title="{Binding WindowTitle}" Height="650" Width="550"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <ObjectDataProvider x:Key="LiveTypeEnum" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:LiveType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="#DDDDDD"/>
            <Setter Property="BorderBrush" Value="#707070"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="10,3"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="4" 
                                SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#EEEEEE"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#CCCCCC"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="CheckBox">
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <StackPanel Orientation="Horizontal" Background="Transparent">
                            <Border x:Name="border" Width="16" Height="16" CornerRadius="3" 
                                    BorderBrush="Gray" BorderThickness="1" Background="White" 
                                    Margin="0,0,5,0" VerticalAlignment="Center">
                                <Path x:Name="CheckMark" Data="M 3,8 L 6,11 L 13,4" 
                                      Stroke="Black" StrokeThickness="2" 
                                      Visibility="Collapsed" 
                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ContentPresenter VerticalAlignment="Center"/>
                        </StackPanel>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckMark" Property="Visibility" Value="Visible"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="Black"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="15">

                <Grid Margin="0,0,0,15" Background="#F5F5F5" Visibility="{Binding Settings.Editor_Thumbnail, Converter={StaticResource BoolToVis}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="0" Width="160" Height="90" 
                        BorderBrush="Gray" BorderThickness="1" 
                        Background="Black" 
                        Margin="10,10,10,10"
                        CornerRadius="5">
                        <Grid>
                            <Border CornerRadius="4">
                                <Border.Background>
                                    <ImageBrush ImageSource="{Binding ClipData.ThumbnailPath, Converter={StaticResource PathToImageConv}}" Stretch="Uniform"/>
                                </Border.Background>
                            </Border>

                            <Border Background="#CC000000" 
                                VerticalAlignment="Bottom" 
                                HorizontalAlignment="Right" 
                                Margin="0,0,4,4" 
                                Padding="4,1" 
                                CornerRadius="3">
                                <TextBlock Text="{Binding ClipData.DurationDisplayStr}" 
                       Foreground="White" 
                       FontSize="11" 
                       FontWeight="Bold"/>
                            </Border>
                        </Grid>
                    </Border>

                    <Grid Grid.Column="1" Margin="0,10,10,10">
                        <TextBlock Text="サムネイル設定" FontWeight="Bold" VerticalAlignment="Top"/>

                        <StackPanel VerticalAlignment="Bottom">
                            <CheckBox Content="自動生成 (区間の中央)" 
                                  IsChecked="{Binding ClipData.IsAutoThumbnail}" 
                                  Margin="0,0,0,5" IsEnabled="{Binding IsEditable}"/>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="手動再生成" Command="{Binding RegenerateThumbnailCommand}" Width="100" Margin="0,0,10,0" 
                                        IsEnabled="{Binding IsEditable}" ToolTip="現在の設定でサムネイルを作り直します"/>
                                <Button Content="ファイル選択..." Click="SelectThumbnail_Click" Width="100" 
                                        IsEnabled="{Binding IsEditable}"/>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Grid>

                <StackPanel Visibility="{Binding Settings.Editor_FilePath, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="動画ファイルパス *:" FontWeight="Bold"/>
                    <Grid Margin="0,5,0,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="FilePathBox" Text="{Binding ClipData.FilePath}" 
                      VerticalContentAlignment="Center" IsEnabled="{Binding IsEditable}"/>
                        <Button Grid.Column="1" Content="..." Width="40" Margin="5,0,0,0" 
                                Click="SelectFile_Click" IsEnabled="{Binding IsEditable}"/>
                    </Grid>
                </StackPanel>
                <TextBlock Text="{Binding FilePathErrorMessage}" Foreground="Red" FontWeight="Bold" Margin="0,0,0,15"/>

                <Grid Margin="0,0,0,15">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Settings.Editor_StartTime}" Value="False"/>
                                        <Condition Binding="{Binding Settings.Editor_EndTime}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Visibility="{Binding Settings.Editor_StartTime, Converter={StaticResource BoolToVis}}">

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="再生開始:" FontWeight="Bold" FontSize="11"/>

                            <Grid Margin="0,5,0,0">
                                <TextBox x:Name="StartTimeBox" 
                                         Text="{Binding ClipData.StartTimeStr, UpdateSourceTrigger=LostFocus}" 
                                         IsEnabled="{Binding IsEditable}" 
                                         LostFocus="Time_LostFocus"
                                         VerticalContentAlignment="Center"
                                         Background="Transparent"/>

                                <TextBlock Text="例: 10:00, 1:23:45 (空欄で最初から)" 
                                           Foreground="Gray" Opacity="0.5"
                                           IsHitTestVisible="False" 
                                           VerticalAlignment="Center" Margin="5,0,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Text, ElementName=StartTimeBox}" Value="">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                            <TextBlock Text="{Binding StartTimeErrorMessage}" Foreground="Red" FontSize="11" TextWrapping="Wrap" Margin="0,2,0,0"/>
                        </StackPanel>
                    </StackPanel>
                    <StackPanel Grid.Column="2" Visibility="{Binding Settings.Editor_EndTime, Converter={StaticResource BoolToVis}}">
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="再生終了 (mm:ss / hh:mm:ss):" FontWeight="Bold" FontSize="11"/>

                            <Grid Margin="0,5,0,0">
                                <TextBox x:Name="EndTimeBox" 
                                         Text="{Binding ClipData.EndTimeStr, UpdateSourceTrigger=LostFocus}" 
                                         IsEnabled="{Binding IsEditable}" 
                                         LostFocus="Time_LostFocus"
                                         VerticalContentAlignment="Center"
                                         Background="Transparent"/>

                                <TextBlock Text="例: 10:00, 1:23:45 (空欄で最後まで)" 
                                           Foreground="Gray" Opacity="0.5"
                                           IsHitTestVisible="False" 
                                           VerticalAlignment="Center" Margin="5,0,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Text, ElementName=EndTimeBox}" Value="">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>

                            <TextBlock Text="{Binding EndTimeErrorMessage}" Foreground="Red" FontSize="11" TextWrapping="Wrap" Margin="0,2,0,0"/>
                        </StackPanel>
                    </StackPanel>
                </Grid>

                <StackPanel Visibility="{Binding Settings.Editor_ClipName, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="クリップ名:" FontWeight="Bold"/>
                    <TextBox Text="{Binding ClipData.ClipName}" Margin="0,5,0,15" IsEnabled="{Binding IsEditable}"/>
                </StackPanel>

                <StackPanel Visibility="{Binding Settings.Editor_SongTitle, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="曲名:" FontWeight="Bold"/>
                    <TextBox Text="{Binding ClipData.SongTitle}" Margin="0,5,0,15" IsEnabled="{Binding IsEditable}"/>
                </StackPanel>

                <StackPanel Visibility="{Binding Settings.Editor_ConcertName, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="公演名:" FontWeight="Bold"/>
                    <TextBox Text="{Binding ClipData.ConcertName}" Margin="0,5,0,15" IsEnabled="{Binding IsEditable}"/>
                </StackPanel>

                <Grid Margin="0,0,0,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Visibility="{Binding Settings.Editor_ConcertDate, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="公演日 (例: 2025/01/01):" FontWeight="Bold"/>

                        <DatePicker x:Name="ConcertDateBox" 
                                    SelectedDate="{Binding ClipData.ConcertDate}" 
                                    IsEnabled="{Binding IsEditable}"
                                    VerticalContentAlignment="Center"
                                    Margin="0,5,0,0"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2" Visibility="{Binding Settings.Editor_LiveType, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="ライブ形式:" FontWeight="Bold"/>
                        <ComboBox ItemsSource="{Binding Source={StaticResource LiveTypeEnum}}" 
                                  SelectedItem="{Binding ClipData.LiveType}" 
                                  Margin="0,5,0,0" IsEnabled="{Binding IsEditable}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource LiveTypeConv}}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                </Grid>
                <StackPanel Visibility="{Binding Settings.Editor_Brands, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="ブランド:" FontWeight="Bold"/>
                    <Border BorderBrush="Gray" BorderThickness="1" Margin="0,5,0,15" Padding="5" CornerRadius="3">
                        <ItemsControl ItemsSource="{Binding BrandList}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding Name}" IsChecked="{Binding IsSelected}" 
                                          IsEnabled="{Binding IsEnabled}" Margin="0,0,15,5"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                </StackPanel>
                <StackPanel Visibility="{Binding Settings.Editor_Performers, Converter={StaticResource BoolToVis}}">
                    <StackPanel Orientation="Horizontal" Margin="0,15,0,5">
                        <TextBlock Text="出演者:" FontWeight="Bold" VerticalAlignment="Center"/>
                        <Button Content="選択..." Width="60" Margin="10,0,0,0" 
                                Click="SelectPerformers_Click" IsEnabled="{Binding IsEditable}" 
                                VerticalAlignment="Center" Height="Auto"/>
                    </StackPanel>

                    <TextBox Text="{Binding PerformersDisplayText, Mode=OneWay}"
                             IsReadOnly="True" VerticalContentAlignment="Top" 
                             MinHeight="50" Height="Auto" MaxHeight="200"
                             TextWrapping="Wrap" AcceptsReturn="True"
                             VerticalScrollBarVisibility="Auto"
                             Margin="0,0,0,15" Background="#F0F0F0"/>
                </StackPanel>

                <StackPanel Visibility="{Binding Settings.Editor_Lyrics, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="歌詞:" FontWeight="Bold"/>
                    <TextBox Text="{Binding ClipData.Lyrics}" MinHeight="60" Height="Auto" MaxHeight="300"
                     AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" 
                     VerticalContentAlignment="Top"
                     Margin="0,5,0,15" IsEnabled="{Binding IsEditable}"/>
                </StackPanel>

                <StackPanel Visibility="{Binding Settings.Editor_Remarks, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="備考:" FontWeight="Bold"/>
                    <TextBox Text="{Binding ClipData.Remarks}" MinHeight="60" Height="Auto" MaxHeight="300"
                     AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" 
                     VerticalContentAlignment="Top"
                     Margin="0,5,0,15" IsEnabled="{Binding IsEditable}"/>
                </StackPanel>

                <Grid Margin="0,5,0,5">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Settings.Editor_PlayCount}" Value="False"/>
                                        <Condition Binding="{Binding Settings.Editor_CreatedAt}" Value="False"/>
                                        <Condition Binding="{Binding Settings.Editor_UpdatedAt}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Visibility="{Binding Settings.Editor_CreatedAt, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="登録日時:" FontWeight="Bold" Foreground="Gray"/>
                        <TextBox Text="{Binding ClipData.CreatedAt, Mode=OneWay, StringFormat=yyyy/MM/dd - HH:mm:ss}" 
                             IsReadOnly="True" Background="#F0F0F0" Margin="0,5,0,0" Foreground="Gray"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Visibility="{Binding Settings.Editor_UpdatedAt, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="更新日時:" FontWeight="Bold" Foreground="Gray"/>
                        <TextBox Text="{Binding ClipData.UpdatedAt, Mode=OneWay, StringFormat=yyyy/MM/dd - HH:mm:ss}" 
                              IsReadOnly="True" Background="#F0F0F0" Margin="0,5,0,0" Foreground="Gray"/>
                    </StackPanel>

                    <StackPanel Grid.Column="4" Visibility="{Binding Settings.Editor_PlayCount, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="再生数:" FontWeight="Bold" Foreground="Gray"/>
                        <TextBox Text="{Binding ClipData.PlayCount, Mode=OneWay, StringFormat={}{0} 回}" 
                        IsReadOnly="True" Background="#F0F0F0" Margin="0,5,0,0" Foreground="Gray"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </ScrollViewer>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,15,15">
            <Button Content="キャンセル" Width="100" Margin="0,0,10,0" IsCancel="True"
                    Visibility="{Binding IsEditable, Converter={StaticResource BoolToVis}}"/>
            <Button Content="{Binding ActionButtonText}" Width="100" Click="Action_Click"/>
        </StackPanel>
    </Grid>
</Window>